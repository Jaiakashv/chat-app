<!DOCTYPE html>
<html>
<head>
  <title>Secure 1:1 Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Emoji Picker -->
  <script type="module">
    import EmojiPicker from "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";
  </script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="bg-white w-full max-w-md h-[600px] rounded-2xl shadow-xl flex flex-col relative">

  <div class="bg-blue-600 text-white p-4 text-center font-semibold rounded-t-2xl">
    Secure 1:1 Chat
  </div>

  <!-- NAME SECTION -->
  <div id="nameSection" class="p-6 space-y-4">
    <input id="nameInput" type="text" placeholder="Enter your name"
      class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">

    <button id="createBtn"
      class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
      Create Secure Room
    </button>

    <div class="flex space-x-2">
      <input id="keyInput" placeholder="Enter Room Key"
        class="flex-1 border rounded-lg p-2">
      <button id="joinBtn"
        class="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600">
        Join
      </button>
    </div>

    <div id="keyDisplay"></div>
    <p id="error" class="text-red-500 text-sm"></p>
  </div>

  <!-- CHAT SECTION -->
  <div id="chatSection" class="hidden flex flex-col flex-1">

    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50"></div>

    <!-- EMOJI PICKER POPUP -->
    <div id="emojiContainer" class="absolute bottom-20 left-4 hidden">
      <emoji-picker></emoji-picker>
    </div>

    <!-- INPUT SECTION -->
    <div class="p-3 border-t flex space-x-2 items-center relative">
      
      <button id="emojiBtn" class="text-2xl">ðŸ˜€</button>

      <input id="msgInput"
        class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Type a message...">

      <button id="recordBtn"
        class="bg-red-500 text-white px-3 rounded-full">
        ðŸŽ™
      </button>

      <button id="sendBtn"
        class="bg-blue-600 text-white px-4 rounded-full hover:bg-blue-700">
        Send
      </button>
    </div>

  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let currentKey = "";
let userName = "";
let mediaRecorder;
let audioChunks = [];

// CREATE ROOM
document.getElementById("createBtn").onclick = () => {
  userName = document.getElementById("nameInput").value.trim();
  if (!userName) return alert("Enter your name");
  socket.emit("create-room");
};

// JOIN ROOM
document.getElementById("joinBtn").onclick = () => {
  userName = document.getElementById("nameInput").value.trim();
  if (!userName) return alert("Enter your name");

  const key = document.getElementById("keyInput").value.trim();
  if (!key) return alert("Enter room key");

  currentKey = key;
  socket.emit("join-room", key);
};

socket.on("room-created", (key) => {
  currentKey = key;
  document.getElementById("keyDisplay").innerHTML = `
    <div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg text-center">
      <p class="font-semibold">Share this Key:</p>
      <span class="text-xl font-bold">${key}</span>
    </div>`;
});

socket.on("start-chat", (key) => {
  currentKey = key;
  document.getElementById("nameSection").classList.add("hidden");
  document.getElementById("chatSection").classList.remove("hidden");
});

// SEND TEXT
document.getElementById("sendBtn").onclick = () => {
  const message = document.getElementById("msgInput").value.trim();
  if (!message) return;

  socket.emit("send-message", { key: currentKey, name: userName, message });
  document.getElementById("msgInput").value = "";
};

// RECEIVE TEXT
socket.on("receive-message", ({ name, message }) => {
  addMessage(name, message, false);
});

// VOICE
document.getElementById("recordBtn").onclick = async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = () => {
        socket.emit("send-voice", {
          key: currentKey,
          name: userName,
          audio: reader.result
        });
      };
    };

    document.getElementById("recordBtn").innerText = "â¹";
  } else {
    mediaRecorder.stop();
    document.getElementById("recordBtn").innerText = "ðŸŽ™";
  }
};

socket.on("receive-voice", ({ name, audio }) => {
  addMessage(name, audio, true);
});

// EMOJI BUTTON
const emojiBtn = document.getElementById("emojiBtn");
const emojiContainer = document.getElementById("emojiContainer");
const picker = document.querySelector("emoji-picker");

emojiBtn.onclick = () => {
  emojiContainer.classList.toggle("hidden");
};

picker.addEventListener("emoji-click", event => {
  document.getElementById("msgInput").value += event.detail.unicode;
});

// ADD MESSAGE
function addMessage(name, content, isAudio) {
  const msgDiv = document.createElement("div");
  const isMe = name === userName;

  msgDiv.className = isMe ? "flex justify-end" : "flex justify-start";

  msgDiv.innerHTML = `
    <div class="${isMe ? 'bg-blue-600 text-white' : 'bg-gray-300'} 
        px-4 py-2 rounded-2xl max-w-xs">
        <p class="text-xs font-semibold">${name}</p>
        ${isAudio
          ? `<audio controls src="${content}" class="mt-1"></audio>`
          : `<p>${content}</p>`}
    </div>
  `;

  document.getElementById("messages").appendChild(msgDiv);
}
</script>

</body>
</html>